<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MindCompass - æƒ…ç»ªç½—ç›˜</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* é»˜è®¤ä¸»é¢˜è‰² */
            --theme-color: #7FA6C4; 
            --bg-color: #F8F9FA;
            --text-color: #333;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #eee;
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            height: 100%;
            max-width: 420px;
            background: var(--bg-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: background 0.5s ease;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            padding: 24px;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.4s ease, transform 0.4s ease;
            transform: scale(0.95);
            background: var(--bg-color); /* ç¡®ä¿èƒŒæ™¯è¦†ç›– */
            z-index: 1;
        }

        .screen.active {
            opacity: 1; pointer-events: auto; transform: scale(1); z-index: 10;
        }

        h1, h2 { margin: 0 0 10px 0; text-align: center; color: var(--text-color); }
        p { text-align: center; color: #666; margin-bottom: 20px; font-size: 14px; }
        
        .btn {
            padding: 16px; border-radius: 12px; border: none;
            background: #333; color: #fff; font-size: 16px; font-weight: 600;
            cursor: pointer; width: 100%; margin-top: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }

        /* --- ä¿®æ”¹ç‚¹1ï¼š20ç§æƒ…ç»ªç½‘æ ¼ --- */
        .emotion-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            width: 100%;
            padding: 10px 0;
        }
        .emo-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #fff; border-radius: 12px;
            padding: 10px 0;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .emo-btn span.emoji { font-size: 28px; margin-bottom: 4px; display: block;}
        .emo-btn span.label { font-size: 12px; color: #555; }
        
        .emo-btn.selected {
            border-color: var(--theme-color);
            background-color: rgba(255,255,255,0.9);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* --- ä¿®æ”¹ç‚¹2ï¼šåŠ¨æ€æ‹–æ‹½é‡åŒ– --- */
        .slider-wrapper {
            width: 100px;
            height: 320px;
            background: #e0e0e0;
            border-radius: 50px;
            position: relative;
            overflow: hidden;
            margin: 20px 0;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.1);
            touch-action: none; /* é˜²æ­¢é¡µé¢æ»šåŠ¨ */
        }
        .fluid-level {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            height: 50%; /* JSæ§åˆ¶ */
            background: var(--theme-color);
            transition: height 0.1s linear, background 0.3s;
            will-change: height;
        }
        /* æ¶²é¢æ³¢æµªæ•ˆæœ */
        .fluid-level::after {
            content: ''; position: absolute; top: -10px; left: 0; width: 100%; height: 20px;
            background: inherit; border-radius: 50%; opacity: 0.8;
            transform: scaleX(1.2);
        }
        .slider-handle-text {
            position: absolute; width: 100%; text-align: center;
            bottom: 20px; color: rgba(255,255,255,0.8); font-size: 24px; font-weight: bold;
            pointer-events: none; z-index: 5;
        }
        .intensity-number {
            font-size: 60px; font-weight: 800; color: var(--theme-color);
            margin-bottom: 10px;
        }

        /* äº‹ä»¶ä¸¥é‡åº¦æ»‘å— */
        .severity-slider {
            -webkit-appearance: none; width: 100%; height: 6px; border-radius: 3px;
            background: #ddd; outline: none; margin: 20px 0;
        }
        .severity-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px; border-radius: 50%;
            background: #666; cursor: pointer; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- ä¿®æ”¹ç‚¹3ï¼šç»“æœå¡ç‰‡ä¿å­˜ --- */
        .result-card-container {
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            width: 100%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            /* åŠ ä¸Šè¿™ä¸ªä¸ºäº†æˆªå›¾æ—¶ä¸åŒ…å«åœ†è§’å¤–çš„èƒŒæ™¯ */
            transform: translateZ(0); 
        }
        .result-card-container::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 8px;
            background: var(--theme-color);
        }
        .card-header { display: flex; align-items: center; margin-bottom: 20px; }
        .card-emoji { font-size: 40px; margin-right: 15px; }
        .card-title { font-size: 20px; font-weight: bold; color: #333; }
        .card-date { font-size: 12px; color: #999; margin-top: 4px; }
        .card-body { font-size: 15px; line-height: 1.6; color: #555; background: #f9f9f9; padding: 15px; border-radius: 10px; }
        .card-suggestion { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; }
        .suggestion-tag { 
            display: inline-block; padding: 4px 8px; border-radius: 4px; 
            font-size: 12px; background: var(--theme-color); color: #fff; margin-bottom: 8px;
        }
        
        /* è¾…åŠ©ç±» */
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div id="screen-intro" class="screen active">
        <h1 style="font-size: 28px;">MindCompass</h1>
        <p>æ•æ‰æƒ…ç»ª Â· é‡åŒ–è¯„ä¼° Â· æ™ºæ…§è°ƒç†</p>
        <div style="font-size: 60px; margin: 40px 0; animation: float 3s infinite ease-in-out;">ğŸ§­</div>
        <button class="btn" onclick="navTo('screen-emotion')">å¼€å§‹è®°å½•</button>
    </div>

    <div id="screen-emotion" class="screen">
        <h2>ç°åœ¨æ„Ÿè§‰å¦‚ä½•ï¼Ÿ</h2>
        <p>ç‚¹å‡»æœ€ç¬¦åˆå½“ä¸‹çš„æƒ…ç»ª</p>
        <div class="emotion-grid" id="emotion-grid-container">
            </div>
        <button class="btn" id="emo-next-btn" style="opacity:0.3; pointer-events:none;" onclick="navTo('screen-intensity')">ä¸‹ä¸€æ­¥</button>
    </div>

    <div id="screen-intensity" class="screen">
        <h2>æƒ…ç»ªæœ‰å¤šå¼ºçƒˆï¼Ÿ</h2>
        <div class="intensity-number" id="intensity-val">5</div>
        <p>æŒ‰ä½æ¶²é¢ä¸Šä¸‹æ‹–åŠ¨</p>
        
        <div class="slider-wrapper" id="drag-slider">
            <div class="fluid-level" id="fluid-level"></div>
            <div class="slider-handle-text">â†•</div>
        </div>

        <button class="btn" onclick="navTo('screen-event')">ç¡®è®¤å¼ºåº¦</button>
    </div>

    <div id="screen-event" class="screen">
        <h2>å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</h2>
        <div style="width:100%; margin-bottom:30px;">
            <textarea id="event-input" placeholder="ç®€å•æè¿°ä¸€ä¸‹..." style="width:100%; height:80px; padding:15px; border-radius:12px; border:1px solid #ddd; resize:none; font-family:inherit;"></textarea>
        </div>
        
        <h2>å®¢è§‚æ¥è¯´å¤šä¸¥é‡ï¼Ÿ</h2>
        <p>å¦‚æœè¿™äº‹å‘ç”Ÿåœ¨æ–°é—»é‡Œæˆ–åˆ«äººèº«ä¸Š</p>
        <div style="font-size:32px; font-weight:bold; color:#666; margin:10px 0;" id="severity-val">5</div>
        <input type="range" class="severity-slider" min="1" max="10" value="5" oninput="updateSeverity(this.value)">
        <div style="display:flex; justify-content:space-between; width:100%; font-size:12px; color:#999;">
            <span>å¾®å°çäº‹</span>
            <span>ä¸­ç­‰æŒ«æŠ˜</span>
            <span>äººç”Ÿå˜æ•…</span>
        </div>

        <button class="btn" onclick="generateResult()">ç”Ÿæˆåˆ†æ</button>
    </div>

    <div id="screen-result" class="screen">
        <h2>æƒ…ç»ªåˆ†ææŠ¥å‘Š</h2>
        <p>æˆªå›¾å·²ç”Ÿæˆï¼Œå¯ä¿å­˜è‡³ç›¸å†Œ</p>
        
        <div id="capture-area" class="result-card-container">
            <div class="card-header">
                <span class="card-emoji" id="res-emoji">ğŸ˜</span>
                <div>
                    <div class="card-title" id="res-emotion-name">æƒ…ç»ªåç§°</div>
                    <div class="card-date" id="res-date">2023.11.24</div>
                </div>
            </div>
            
            <div class="card-body">
                <strong>äº‹ä»¶ï¼š</strong> <span id="res-event">...</span><br><br>
                <div style="display:flex; gap:10px; margin-top:5px;">
                    <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:12px;">å¼ºåº¦: <span id="res-int">0</span>/10</span>
                    <span style="background:#eee; padding:2px 6px; border-radius:4px; font-size:12px;">ä¸¥é‡åº¦: <span id="res-sev">0</span>/10</span>
                </div>
            </div>

            <div class="card-suggestion">
                <span class="suggestion-tag" id="res-tag">å»ºè®®</span>
                <div id="res-advice" style="font-size:14px; color:#333; font-weight:500;">
                    å»ºè®®å†…å®¹...
                </div>
            </div>
        </div>

        <button class="btn" onclick="saveCard()">ğŸ“¥ ä¿å­˜åˆ°ç›¸å†Œ</button>
        <button class="btn" style="background:transparent; color:#999; margin-top:10px;" onclick="location.reload()">é‡æ–°è®°å½•</button>
    </div>

</div>

<script>
    // --- æ•°æ®é…ç½®ï¼š20ç§æƒ…ç»ª ---
    // å–œ(Joy-é»„), æ€’(Anger-çº¢), å“€(Sad-è“), æƒ§(Fear-ç´«), æ‚(Mix-é’)
    const emotions = [
        // Row 1: Joy (Yellow/Orange)
        { label: 'å¼€å¿ƒ', emoji: 'ğŸ˜†', color: '#FFD93D', type: 'pos' },
        { label: 'æ”¾æ¾', emoji: 'ğŸ˜Œ', color: '#FFC75F', type: 'pos' },
        { label: 'å…´å¥‹', emoji: 'ğŸ¤©', color: '#FF9642', type: 'pos' },
        { label: 'å¹¸ç¦', emoji: 'ğŸ¥°', color: '#FF8066', type: 'pos' },
        // Row 2: Anger (Red)
        { label: 'æ„¤æ€’', emoji: 'ğŸ˜¡', color: '#FF6B6B', type: 'neg' },
        { label: 'æŒ«è´¥', emoji: 'ğŸ˜¤', color: '#E05D5D', type: 'neg' },
        { label: 'çƒ¦èº', emoji: 'ğŸ˜’', color: '#D98C8C', type: 'neg' },
        { label: 'æš´æ€’', emoji: 'ğŸ¤¬', color: '#C70039', type: 'neg' },
        // Row 3: Sadness (Blue)
        { label: 'æ‚²ä¼¤', emoji: 'ğŸ˜­', color: '#4D96FF', type: 'neg' },
        { label: 'å¤±æœ›', emoji: 'ğŸ˜”', color: '#6BCB77', type: 'neg' }, // Greenish blue
        { label: 'å­¤ç‹¬', emoji: 'ğŸ˜', color: '#3AB4F2', type: 'neg' },
        { label: 'ç–²æƒ«', emoji: 'ğŸ˜«', color: '#7FA6C4', type: 'neg' },
        // Row 4: Fear/Anxiety (Purple)
        { label: 'ææƒ§', emoji: 'ğŸ˜¨', color: '#845EC2', type: 'neg' },
        { label: 'ç„¦è™‘', emoji: 'ğŸ˜°', color: '#9B89B3', type: 'neg' },
        { label: 'ç´§å¼ ', emoji: 'ğŸ˜¬', color: '#B39CD0', type: 'neg' },
        { label: 'ç¾è€»', emoji: 'ğŸ˜³', color: '#D65DB1', type: 'neg' },
        // Row 5: Others
        { label: 'å«‰å¦’', emoji: 'ğŸ˜ ', color: '#FF5E78', type: 'neg' },
        { label: 'å§”å±ˆ', emoji: 'ğŸ¥º', color: '#9EBAAA', type: 'neg' },
        { label: 'è¿·èŒ«', emoji: 'ğŸ˜µ', color: '#A0A0A0', type: 'neg' },
        { label: 'éº»æœ¨', emoji: 'ğŸ˜', color: '#7E7E7E', type: 'neg' }
    ];

    // å…¨å±€çŠ¶æ€
    let state = {
        selectedEmo: null,
        intensity: 5,
        severity: 5,
        eventText: ""
    };

    // åˆå§‹åŒ–æƒ…ç»ªç½‘æ ¼
    const grid = document.getElementById('emotion-grid-container');
    emotions.forEach((emo, index) => {
        const btn = document.createElement('div');
        btn.className = 'emo-btn';
        btn.innerHTML = `<span class="emoji">${emo.emoji}</span><span class="label">${emo.label}</span>`;
        btn.onclick = () => selectEmotion(index, btn);
        grid.appendChild(btn);
    });

    // å¯¼èˆª
    function navTo(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    // 1. é€‰æ‹©æƒ…ç»ªé€»è¾‘
    function selectEmotion(index, btnEl) {
        state.selectedEmo = emotions[index];
        
        // UI æ›´æ–°
        document.querySelectorAll('.emo-btn').forEach(b => b.classList.remove('selected'));
        btnEl.classList.add('selected');
        
        // æ›´æ–°ä¸»é¢˜è‰²
        document.documentElement.style.setProperty('--theme-color', state.selectedEmo.color);
        
        // æ¿€æ´»æŒ‰é’®
        const nextBtn = document.getElementById('emo-next-btn');
        nextBtn.style.opacity = 1;
        nextBtn.style.pointerEvents = 'auto';
    }

    // 2. åŠ¨æ€æ‹–æ‹½é€»è¾‘ (Mouse & Touch)
    const slider = document.getElementById('drag-slider');
    const level = document.getElementById('fluid-level');
    const valDisplay = document.getElementById('intensity-val');
    let isDragging = false;

    function updateLevel(clientY) {
        const rect = slider.getBoundingClientRect();
        let y = clientY - rect.top; // y position relative to slider top
        // Clamp
        if (y < 0) y = 0;
        if (y > rect.height) y = rect.height;
        
        // Calculate percentage (0 at bottom, 1 at top) -> å®é™…ä¸Š y=0 is top
        let pct = 1 - (y / rect.height);
        
        // Update CSS height
        level.style.height = (pct * 100) + '%';
        
        // Map to 1-10 integer
        let score = Math.ceil(pct * 10);
        if (score < 1) score = 1;
        state.intensity = score;
        valDisplay.innerText = score;
    }

    // Mouse Events
    slider.addEventListener('mousedown', (e) => { isDragging = true; updateLevel(e.clientY); });
    window.addEventListener('mousemove', (e) => { if(isDragging) { e.preventDefault(); updateLevel(e.clientY); } });
    window.addEventListener('mouseup', () => { isDragging = false; });

    // Touch Events
    slider.addEventListener('touchstart', (e) => { isDragging = true; updateLevel(e.touches[0].clientY); });
    window.addEventListener('touchmove', (e) => { 
        if(isDragging) { 
            e.preventDefault(); // é˜»æ­¢æ»šåŠ¨
            updateLevel(e.touches[0].clientY); 
        } 
    }, {passive: false});
    window.addEventListener('touchend', () => { isDragging = false; });


    // 3. ä¸¥é‡åº¦æ›´æ–°
    function updateSeverity(val) {
        state.severity = val;
        document.getElementById('severity-val').innerText = val;
    }

    // 4. ç”Ÿæˆç»“æœ
    function generateResult() {
        state.eventText = document.getElementById('event-input').value || "æœªè®°å½•å…·ä½“äº‹ä»¶";
        const date = new Date();
        
        // å¡«å……å¡ç‰‡æ•°æ®
        document.getElementById('res-emoji').innerText = state.selectedEmo.emoji;
        document.getElementById('res-emotion-name').innerText = state.selectedEmo.label;
        document.getElementById('res-date').innerText = `${date.getFullYear()}.${date.getMonth()+1}.${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
        document.getElementById('res-event').innerText = state.eventText;
        document.getElementById('res-int').innerText = state.intensity;
        document.getElementById('res-sev').innerText = state.severity;
        
        // æ ¸å¿ƒè¯„ä¼°é€»è¾‘
        const tagEl = document.getElementById('res-tag');
        const adviceEl = document.getElementById('res-advice');
        
        // é€»è¾‘åˆ†æ”¯
        if (state.selectedEmo.type === 'pos') {
            // æ­£é¢æƒ…ç»ª
            tagEl.innerText = "âœ¨ å€¼å¾—è®°å½•";
            adviceEl.innerText = "ç§¯æçš„æƒ…ç»ªæ˜¯å¿ƒç†èƒ½é‡çš„æ¥æºã€‚å¥½å¥½äº«å—è¿™ä¸€åˆ»ï¼ŒæŠŠå®ƒå­˜è¿›ä½ çš„èƒ½é‡é“¶è¡Œå§ï¼";
        } else {
            // è´Ÿé¢æƒ…ç»ª
            let delta = state.intensity - state.severity;
            if (delta > 2) {
                // è¿‡åº¦ååº” -> è°ƒç†
                tagEl.innerText = "ğŸŒŠ æƒ…ç»ªè¿‡è½½";
                adviceEl.innerHTML = "ä½ çš„ååº”å¼ºåº¦æ˜¾è‘—é«˜äºäº‹ä»¶æœ¬èº«ã€‚è¿™è¡¨æ˜ä½ å¯èƒ½ç´¯äº†ï¼Œæˆ–è€…è§¦ç¢°äº†æ·±å±‚æ‰³æœºç‚¹ã€‚<br>å»ºè®®ï¼šæ·±å‘¼å¸ï¼Œå…ˆå¤„ç†æƒ…ç»ªï¼Œå†å¤„ç†äº‹æƒ…ã€‚";
            } else if (state.intensity >= 8 && state.severity >= 8) {
                // åˆç†ä½†ç—›è‹¦ -> æ”¯æŒ
                tagEl.innerText = "ğŸ›¡ï¸ è‰°éš¾æ—¶åˆ»";
                adviceEl.innerText = "è¿™æ˜¯ä¸€æ¬¡é‡å¤§çš„å†²å‡»ï¼Œæ„Ÿåˆ°å´©æºƒæ˜¯å®Œå…¨æ­£å¸¸çš„ã€‚ä¸è¦å¯¹è‡ªå·±å¤ªè‹›åˆ»ï¼Œå…è®¸è‡ªå·±æ‚²ä¼¤ã€‚";
            } else {
                // é€‚åº”æ€§ -> è¡¨è¾¾
                tagEl.innerText = "âœ… é€‚åº”æ€§ååº”";
                adviceEl.innerText = "ä½ çš„æƒ…ç»ªååº”å¾ˆæ°å½“ã€‚è¯•ç€å‘ç›¸å…³çš„äººè¡¨è¾¾ä½ çš„éœ€æ±‚ï¼šâ€œæˆ‘æ„Ÿåˆ°...å› ä¸ºæˆ‘çœ‹é‡...å¸Œæœ›ä½ ...â€";
            }
        }
        
        navTo('screen-result');
    }

    // 5. ä¿å­˜å›¾ç‰‡
    function saveCard() {
        const captureElement = document.getElementById('capture-area');
        
        // ä¸´æ—¶å¢åŠ  scale ä»¥æé«˜æ¸…æ™°åº¦
        html2canvas(captureElement, {
            scale: 2, 
            backgroundColor: "#ffffff",
            useCORS: true
        }).then(canvas => {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            link.download = `MindCompass_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
            
            // ç®€å•çš„æç¤º
            alert("å›¾ç‰‡å·²ç”Ÿæˆï¼å¦‚æœæœªè‡ªåŠ¨ä¸‹è½½ï¼Œè¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜ã€‚");
        });
    }

    // ç®€å•çš„æ¼‚æµ®åŠ¨ç”» Keyframe
    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
    `;
    document.head.appendChild(styleSheet);

</script>
</body>
</html>